<div class="surface-ground min-h-screen px-4 py-6 sm:px-6 lg:px-8">
  <main class="mx-auto flex w-full max-w-7xl flex-col gap-6">
    <p-toolbar styleClass="surface-card border-round-3xl shadow-2 px-5 py-4">
      <ng-template pTemplate="start">
        <div class="flex items-center gap-3">
          <p-avatar
            shape="circle"
            [label]="brandInitials()"
            styleClass="bg-primary text-white font-semibold text-base"
          ></p-avatar>
          <div class="flex flex-col">
            <span class="text-xl font-semibold text-surface-900">Task Manager</span>
            <small class="text-sm text-surface-600">{{ organizationLabel() }}</small>
          </div>
        </div>
      </ng-template>
      <ng-template pTemplate="end">
        <div class="flex flex-wrap items-center justify-end gap-2">
          <button
            pButton
            type="button"
            icon="pi pi-plus"
            rounded
            (click)="openCreateDialog()"
          >
            New Task
          </button>
          <button
            pButton
            type="button"
            icon="pi pi-bell"
            severity="secondary"
            rounded
            aria-label="Notifications"
          >
            <span class="sr-only">Notifications</span>
          </button>
          <button
            pButton
            type="button"
            icon="pi pi-sign-out"
            severity="secondary"
            rounded
            (click)="logout()"
            aria-label="Logout"
          >
            <span class="sr-only">Logout</span>
          </button>
        </div>
      </ng-template>
    </p-toolbar>

    <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
      <p-card styleClass="border-none surface-card border-round-3xl shadow-1">
        <ng-template pTemplate="header">
          <div class="flex items-center justify-between text-surface-500">
            <span class="text-sm font-medium">Total Tasks</span>
            <i class="pi pi-clock text-lg"></i>
          </div>
        </ng-template>
        <div class="mt-3">
          <span class="text-4xl font-semibold text-surface-900">{{ summary().total }}</span>
          <p class="mt-1 text-sm text-surface-600">Active tasks in system</p>
        </div>
      </p-card>
      <p-card styleClass="border-none surface-card border-round-3xl shadow-1">
        <ng-template pTemplate="header">
          <div class="flex items-center justify-between text-surface-500">
            <span class="text-sm font-medium">Completed</span>
            <i class="pi pi-check-circle text-lg"></i>
          </div>
        </ng-template>
        <div class="mt-3">
          <span class="text-4xl font-semibold text-surface-900">{{ summary().completed }}</span>
          <p class="mt-1 text-sm text-surface-600">Tasks completed this week</p>
        </div>
      </p-card>
      <p-card styleClass="border-none surface-card border-round-3xl shadow-1">
        <ng-template pTemplate="header">
          <div class="flex items-center justify-between text-surface-500">
            <span class="text-sm font-medium">High Priority</span>
            <i class="pi pi-exclamation-triangle text-lg"></i>
          </div>
        </ng-template>
        <div class="mt-3">
          <span class="text-4xl font-semibold text-surface-900">{{ summary().highPriority }}</span>
          <p class="mt-1 text-sm text-surface-600">Urgent tasks needing attention</p>
        </div>
      </p-card>
      <p-card styleClass="border-none surface-card border-round-3xl shadow-1">
        <ng-template pTemplate="header">
          <div class="flex items-center justify-between text-surface-500">
            <span class="text-sm font-medium">Team Members</span>
            <i class="pi pi-users text-lg"></i>
          </div>
        </ng-template>
        <div class="mt-3">
          <span class="text-4xl font-semibold text-surface-900">{{ summary().contributors }}</span>
          <p class="mt-1 text-sm text-surface-600">Contributors across all tasks</p>
        </div>
      </p-card>
    </div>

    <p-tabs
      [value]="activeTab()"
      (valueChange)="switchTab($event)"
      styleClass="surface-card border-round-3xl shadow-2 overflow-hidden"
    >
      <p-tablist>
        <p-tab value="tasks">Task Management</p-tab>
        <p-tab value="audit">Audit Log</p-tab>
      </p-tablist>
      <p-tabpanels>
        <p-tabpanel value="tasks">
          <div class="flex flex-col gap-4">
            <form
              [formGroup]="filterForm"
              class="grid gap-3 rounded-3xl border border-surface-200 bg-surface-0 p-5 md:grid-cols-2 xl:grid-cols-5"
            >
              <span class="p-input-icon-left md:col-span-2 xl:col-span-2">
                <i class="pi pi-search"></i>
                <input
                  pInputText
                  formControlName="search"
                  type="search"
                  placeholder="Search tasks"
                  class="w-full"
                />
              </span>
              <p-select
                formControlName="status"
                [options]="statusFilterOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="All status"
                class="w-full"
              ></p-select>
              <p-select
                formControlName="priority"
                [options]="priorityFilterOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="All priority"
                class="w-full"
              ></p-select>
              <p-select
                formControlName="category"
                [options]="categoryFilterOptions()"
                optionLabel="label"
                optionValue="value"
                placeholder="All categories"
                class="w-full"
              ></p-select>
              <div class="flex items-center justify-end gap-2 md:col-span-2 xl:col-span-1">
                <button pButton type="button" icon="pi pi-sort" severity="secondary">
                  Sort
                </button>
                <button pButton type="button" icon="pi pi-sliders-h" severity="secondary">
                  Filters
                </button>
              </div>
            </form>

            <p-message
              *ngIf="loading()"
              severity="info"
              text="Synchronizing latest tasksâ€¦"
              styleClass="border-round-2xl"
            ></p-message>

            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 2xl:grid-cols-4">
              <div *ngFor="let column of statusColumns" class="flex flex-col gap-3">
                <p-panel styleClass="h-full border-round-3xl surface-section shadow-2">
                  <ng-template pTemplate="header">
                    <div class="flex items-center justify-between gap-3">
                      <div>
                        <span class="text-base font-semibold text-surface-900">{{ column.title }}</span>
                        <p class="m-0 text-xs text-surface-500">{{ column.description }}</p>
                      </div>
                      <p-badge
                        [value]="tasksByStatus()[column.status].length || 0"
                        severity="info"
                      ></p-badge>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="content">
                    <div
                      cdkDropList
                      [cdkDropListData]="tasksByStatus()[column.status]"
                      (cdkDropListDropped)="drop($event, column.status)"
                      class="flex flex-col gap-3"
                    >
                      <p-card
                        *ngFor="let task of tasksByStatus()[column.status]"
                        cdkDrag
                        [cdkDragData]="task"
                        styleClass="border-round-2xl shadow-1 cursor-grab transition-shadow hover:shadow-3"
                      >
                        <div class="flex items-start justify-between gap-3">
                          <div class="flex flex-col gap-2">
                            <span class="text-base font-semibold text-surface-900">{{ task.title }}</span>
                            <p class="m-0 text-sm text-surface-600">
                              {{ task.description || 'No description supplied.' }}
                            </p>
                          </div>
                          <p-tag
                            [value]="task.priority"
                            [severity]="prioritySeverity(task.priority)"
                            rounded
                            size="small"
                          ></p-tag>
                        </div>
                        <div class="mt-3 flex flex-wrap gap-2 text-xs">
                          <p-chip [label]="task.category || 'General'" icon="pi pi-folder"></p-chip>
                          <p-chip [label]="'Org: ' + (task.organizationId | slice:0:8)" icon="pi pi-sitemap"></p-chip>
                          <p-chip [label]="'Owner: ' + (task.createdById | slice:0:8)" icon="pi pi-user"></p-chip>
                          <p-chip
                            *ngIf="task.dueDate"
                            [label]="'Due ' + (task.dueDate | date: 'MMM d')"
                            icon="pi pi-calendar"
                          ></p-chip>
                        </div>
                      </p-card>
                      <div
                        *ngIf="tasksByStatus()[column.status].length === 0"
                        class="flex flex-col items-center justify-center gap-2 border-2 border-dashed border-surface-200 border-round-2xl py-6 text-sm text-surface-500"
                      >
                        <i class="pi pi-inbox text-lg"></i>
                        <span>No tasks in this lane.</span>
                      </div>
                    </div>
                  </ng-template>
                </p-panel>
              </div>
            </div>
          </div>
        </p-tabpanel>
        <p-tabpanel value="audit">
          <div class="flex flex-col gap-4">
            <p-message *ngIf="auditLoading()" severity="info" text="Loading recent activityâ€¦"></p-message>
            <p-message *ngIf="auditError()" severity="error" [text]="auditError()!"></p-message>
            <div *ngIf="!auditLoading()" class="flex flex-col gap-3">
              <p-card *ngFor="let entry of auditEntries()" styleClass="border-round-2xl shadow-1">
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                  <div class="flex items-center gap-3">
                    <p-avatar
                      shape="circle"
                      [label]="actorInitials(entry)"
                      styleClass="bg-surface-900 text-white"
                    ></p-avatar>
                    <div class="flex flex-col">
                      <span class="font-medium text-surface-900">{{ auditLabel(entry) }}</span>
                      <small class="text-surface-500">{{ entry.resourceType }} Â· {{ entry.resourceId | slice:0:8 }}</small>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <p-tag [value]="auditLabel(entry)" [severity]="auditSeverity(entry)"></p-tag>
                    <small class="text-surface-500">{{ formatTimestamp(entry.createdAt) }}</small>
                  </div>
                </div>
                <p *ngIf="auditMetadata(entry) as metaText" class="m-0 text-sm text-surface-600">
                  {{ metaText }}
                </p>
              </p-card>
              <div
                *ngIf="!auditEntries().length && !auditError()"
                class="flex flex-col items-center gap-2 border-2 border-dashed border-surface-200 border-round-2xl py-6 text-sm text-surface-500"
              >
                <i class="pi pi-ellipsis-h text-lg"></i>
                <span>No audit activity recorded yet.</span>
              </div>
            </div>
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </main>

  <p-dialog
    header="Create new task"
    [visible]="isCreateDialogOpen()"
    (onHide)="closeCreateDialog()"
    [modal]="true"
    styleClass="w-full max-w-2xl"
  >
    <form [formGroup]="createForm" (ngSubmit)="createTask()" class="grid gap-4 md:grid-cols-2">
      <div class="md:col-span-2">
        <span class="p-float-label">
          <input pInputText id="task-title" formControlName="title" class="w-full" />
          <label for="task-title">Title</label>
        </span>
      </div>
      <div class="md:col-span-2">
        <span class="p-float-label">
          <textarea
            pTextarea
            autoResize
            rows="3"
            id="task-description"
            formControlName="description"
            class="w-full"
          ></textarea>
          <label for="task-description">Description</label>
        </span>
      </div>
      <div>
        <span class="p-float-label">
          <input pInputText id="task-category" formControlName="category" class="w-full" />
          <label for="task-category">Category</label>
        </span>
      </div>
      <div>
        <p-select
          formControlName="organizationId"
          [options]="organizations()"
          optionLabel="name"
          optionValue="id"
          placeholder="Select organization"
          class="w-full"
        ></p-select>
      </div>
      <div>
        <p-select
          formControlName="status"
          [options]="statusColumns"
          optionLabel="title"
          optionValue="status"
          placeholder="Select status"
          class="w-full"
        ></p-select>
      </div>
      <div>
        <p-select
          formControlName="priority"
          [options]="prioritySelectOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select priority"
          class="w-full"
        ></p-select>
      </div>
      <div>
        <p-datepicker
          formControlName="dueDate"
          inputId="task-due-date"
          dateFormat="yy-mm-dd"
          showIcon
          class="w-full"
        ></p-datepicker>
      </div>
      <div>
        <span class="p-float-label">
          <input pInputText id="task-assignee" formControlName="assigneeId" class="w-full" />
          <label for="task-assignee">Assign to (optional)</label>
        </span>
      </div>
      <div class="md:col-span-2 flex justify-end gap-2 pt-2">
        <button pButton type="button" severity="secondary" (click)="closeCreateDialog()">
          Cancel
        </button>
        <button pButton type="submit" icon="pi pi-save" [disabled]="createForm.invalid">
          Create task
        </button>
      </div>
    </form>
  </p-dialog>
</div>
