<div
  style="
    background-color: rgb(248, 250, 252);
    min-height: 100vh;
    padding-left: 1rem;
    padding-right: 1rem;
    padding-top: 1.5rem;
    padding-bottom: 1.5rem;
  "
>
  <main
    style="
      margin-left: auto;
      margin-right: auto;
      display: flex;
      width: 100%;
      max-width: 80rem;
      flex-direction: column;
      gap: 1.5rem;
    "
  >
    <p-toolbar
      style="
        background-color: #fff;
        border-radius: 1.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -4px rgba(0, 0, 0, 0.1);
        padding-left: 1.25rem;
        padding-right: 1.25rem;
        padding-top: 1rem;
        padding-bottom: 1rem;
      "
    >
      <ng-template pTemplate="start">
        <div style="display: flex; align-items: center; gap: 0.75rem">
          <p-avatar
            shape="circle"
            [label]="brandInitials()"
            style="
              background-color: rgb(37, 99, 235);
              color: #fff;
              font-weight: 600;
              font-size: 1rem;
              line-height: 1.5rem;
            "
          ></p-avatar>
          <div style="display: flex; flex-direction: column">
            <span
              style="
                font-size: 1.25rem;
                line-height: 1.75rem;
                font-weight: 600;
                color: rgb(17, 24, 39);
              "
              >Task Manager</span
            >
            <small
              style="
                font-size: 0.875rem;
                line-height: 1.25rem;
                color: rgb(75, 85, 99);
              "
              >{{ organizationLabel() }}</small
            >
          </div>
        </div>
      </ng-template>
      <ng-template pTemplate="end">
        <div
          style="
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
          "
        >
          <button pButton type="button" rounded (click)="openCreateDialog()">
            New Task
          </button>
          <button
            pButton
            type="button"
            severity="secondary"
            rounded
            aria-label="Notifications"
          >
            <span class="sr-only">Notifications</span>
          </button>
          <button
            pButton
            type="button"
            severity="secondary"
            rounded
            (click)="logout()"
            aria-label="Logout"
          >
            <span class="sr-only">Logout</span>
          </button>
        </div>
      </ng-template>
    </p-toolbar>

    <!-- Summary cards -->
    <div
      style="
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      "
    >
      <p-card
        [style]="{
          border: 'none',
          'background-color': '#fff',
          'border-radius': '1.5rem',
          'box-shadow':
            '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1)'
        }"
      >
        <ng-template pTemplate="header">
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              color: rgb(107, 114, 128);
            "
          >
            <span
              style="
                font-size: 0.875rem;
                line-height: 1.25rem;
                font-weight: 500;
              "
              >Total Tasks</span
            >
          </div>
        </ng-template>
        <div style="margin-top: 0.75rem">
          <span
            style="
              font-size: 2.25rem;
              line-height: 2.5rem;
              font-weight: 600;
              color: rgb(17, 24, 39);
            "
          >
            {{ summary().total }}
          </span>
          <p
            style="
              margin-top: 0.25rem;
              font-size: 0.875rem;
              line-height: 1.25rem;
              color: rgb(75, 85, 99);
            "
          >
            Active tasks in system
          </p>
        </div>
      </p-card>
      <p-card
        [style]="{
          border: 'none',
          'background-color': '#fff',
          'border-radius': '1.5rem',
          'box-shadow':
            '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1)'
        }"
      >
        <ng-template pTemplate="header">
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              color: rgb(107, 114, 128);
            "
          >
            <span
              style="
                font-size: 0.875rem;
                line-height: 1.25rem;
                font-weight: 500;
              "
              >Completed</span
            >
          </div>
        </ng-template>
        <div style="margin-top: 0.75rem">
          <span
            style="
              font-size: 2.25rem;
              line-height: 2.5rem;
              font-weight: 600;
              color: rgb(17, 24, 39);
            "
            >{{ summary().completed }}</span
          >
          <p
            style="
              margin-top: 0.25rem;
              font-size: 0.875rem;
              line-height: 1.25rem;
              color: rgb(75, 85, 99);
            "
          >
            Tasks completed this week
          </p>
        </div>
      </p-card>
      <p-card
        [style]="{
          border: 'none',
          'background-color': '#fff',
          'border-radius': '1.5rem',
          'box-shadow':
            '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1)'
        }"
      >
        <ng-template pTemplate="header">
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              color: rgb(107, 114, 128);
            "
          >
            <span
              style="
                font-size: 0.875rem;
                line-height: 1.25rem;
                font-weight: 500;
              "
              >High Priority</span
            >
          </div>
        </ng-template>
        <div style="margin-top: 0.75rem">
          <span
            style="
              font-size: 2.25rem;
              line-height: 2.5rem;
              font-weight: 600;
              color: rgb(17, 24, 39);
            "
            >{{ summary().highPriority }}</span
          >
          <p
            style="
              margin-top: 0.25rem;
              font-size: 0.875rem;
              line-height: 1.25rem;
              color: rgb(75, 85, 99);
            "
          >
            Urgent tasks needing attention
          </p>
        </div>
      </p-card>
      <p-card
        [style]="{
          border: 'none',
          'background-color': '#fff',
          'border-radius': '1.5rem',
          'box-shadow':
            '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1)'
        }"
      >
        <ng-template pTemplate="header">
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              color: rgb(107, 114, 128);
            "
          >
            <span
              style="
                font-size: 0.875rem;
                line-height: 1.25rem;
                font-weight: 500;
              "
              >Team Members</span
            >
          </div>
        </ng-template>
        <div style="margin-top: 0.75rem">
          <span
            style="
              font-size: 2.25rem;
              line-height: 2.5rem;
              font-weight: 600;
              color: rgb(17, 24, 39);
            "
            >{{ summary().contributors }}</span
          >
          <p
            style="
              margin-top: 0.25rem;
              font-size: 0.875rem;
              line-height: 1.25rem;
              color: rgb(75, 85, 99);
            "
          >
            Contributors across all tasks
          </p>
        </div>
      </p-card>
    </div>

    <p-tabs
      [value]="activeTab()"
      (valueChange)="switchTab($event)"
      style="
        background-color: #fff;
        border-radius: 1.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      "
    >
      <p-tablist>
        <p-tab value="tasks">Task Management</p-tab>
        <p-tab value="audit">Audit Log</p-tab>
      </p-tablist>
      <p-tabpanels>
        <p-tabpanel value="tasks">
          <div style="display: flex; flex-direction: column; gap: 1rem">
            <form
              [formGroup]="filterForm"
              (ngSubmit)="applyFilters()"
              style="
                display: grid;
                gap: 0.75rem;
                border-radius: 1.5rem;
                border: 1px solid rgb(229, 231, 235);
                background-color: #fff;
                padding: 1.25rem;
              "
            >
              <span style="/* input-icon-left container */">
                <input
                  pInputText
                  formControlName="search"
                  type="search"
                  placeholder="Search tasks"
                  style="width: 100%"
                />
              </span>
              <p-select
                formControlName="status"
                [options]="statusFilterOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="All status"
                style="width: 100%"
              ></p-select>
              <p-select
                formControlName="priority"
                [options]="priorityFilterOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="All priority"
                style="width: 100%"
              ></p-select>
              <p-select
                formControlName="category"
                [options]="categoryFilterOptions()"
                optionLabel="label"
                optionValue="value"
                placeholder="All categories"
                style="width: 100%"
              ></p-select>
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: flex-end;
                  gap: 0.5rem;
                "
              >
                <p-menu #sortMenu [model]="sortMenuItems" [popup]="true"></p-menu>
                <button
                  pButton
                  type="button"
                  icon="pi pi-sort"
                  severity="secondary"
                  (click)="sortMenu.toggle($event)"
                >
                  Sort ({{ activeSortLabel }})
                </button>
                <button
                  pButton
                  type="submit"
                  icon="pi pi-sliders-h"
                  severity="secondary"
                >
                  Apply Filters
                </button>
              </div>
            </form>

            <p-message
              *ngIf="loading()"
              severity="info"
              text="Synchronizing latest tasks…"
              [style]="{ 'border-radius': '1rem' }"
            ></p-message>

            <div style="display: grid; grid-template-columns: 1fr; gap: 1rem">
              <div
                *ngFor="let column of statusColumns"
                style="display: flex; flex-direction: column; gap: 0.75rem"
              >
                <p-panel
                  style="
                    height: 100%;
                    border-radius: 1.5rem;
                    background-color: rgb(250, 250, 250);
                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                      0 4px 6px -4px rgba(0, 0, 0, 0.1);
                  "
                >
                  <ng-template pTemplate="header">
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        gap: 0.75rem;
                      "
                    >
                      <div>
                        <span
                          style="
                            font-size: 1rem;
                            line-height: 1.5rem;
                            font-weight: 600;
                            color: rgb(17, 24, 39);
                          "
                          >{{ column.title }}</span
                        >
                        <p
                          style="
                            margin: 0;
                            font-size: 0.75rem;
                            line-height: 1rem;
                            color: rgb(107, 114, 128);
                          "
                        >
                          {{ column.description }}
                        </p>
                      </div>
                      <p-badge
                        [value]="tasksByStatus()[column.status].length || 0"
                        severity="info"
                      ></p-badge>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="content">
                    <div
                      cdkDropList
                      [cdkDropListData]="tasksByStatus()[column.status]"
                      (cdkDropListDropped)="drop($event, column.status)"
                      style="
                        display: flex;
                        flex-direction: column;
                        gap: 0.75rem;
                      "
                    >
                      <p-card
                        *ngFor="let task of tasksByStatus()[column.status]"
                        cdkDrag
                        [cdkDragData]="task"
                        [style]="{
                          'border-radius': '1rem',
                          'box-shadow':
                            '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1)',
                          cursor: 'grab',
                          transition: 'box-shadow 0.2s ease'
                        }"
                      >
                        <div
                          style="
                            display: flex;
                            align-items: flex-start;
                            justify-content: space-between;
                            gap: 0.75rem;
                          "
                        >
                          <div
                            style="
                              display: flex;
                              flex-direction: column;
                              gap: 0.5rem;
                            "
                          >
                            <span
                              style="
                                font-size: 1rem;
                                line-height: 1.5rem;
                                font-weight: 600;
                                color: rgb(17, 24, 39);
                              "
                              >{{ task.title }}</span
                            >
                            <p
                              style="
                                margin: 0;
                                font-size: 0.875rem;
                                line-height: 1.25rem;
                                color: rgb(75, 85, 99);
                              "
                            >
                              {{
                                task.description || 'No description supplied.'
                              }}
                            </p>
                          </div>
                          <p-tag
                            [value]="task.priority"
                            [severity]="prioritySeverity(task.priority)"
                            rounded
                            size="small"
                          ></p-tag>
                        </div>
                        <div
                          style="
                            margin-top: 0.75rem;
                            display: flex;
                            flex-wrap: wrap;
                            gap: 0.5rem;
                            font-size: 0.75rem;
                            line-height: 1rem;
                          "
                        >
                          <p-chip
                            [label]="task.category || 'General'"
                            icon="pi pi-folder"
                          ></p-chip>
                          <p-chip
                            [label]="
                              'Org: ' + (task.organizationId | slice : 0 : 8)
                            "
                            icon="pi pi-sitemap"
                          ></p-chip>
                          <p-chip
                            [label]="
                              'Owner: ' + (task.createdById | slice : 0 : 8)
                            "
                            icon="pi pi-user"
                          ></p-chip>
                          <p-chip
                            *ngIf="task.dueDate"
                            [label]="'Due ' + (task.dueDate | date : 'MMM d')"
                            icon="pi pi-calendar"
                          ></p-chip>
                        </div>
                      </p-card>
                      <div
                        *ngIf="tasksByStatus()[column.status].length === 0"
                        style="
                          display: flex;
                          flex-direction: column;
                          align-items: center;
                          justify-content: center;
                          gap: 0.5rem;
                          border: 2px dashed rgb(229, 231, 235);
                          border-radius: 1rem;
                          padding-top: 1.5rem;
                          padding-bottom: 1.5rem;
                          font-size: 0.875rem;
                          line-height: 1.25rem;
                          color: rgb(107, 114, 128);
                        "
                      >
                        <i
                          class="pi pi-inbox"
                          style="font-size: 1.125rem; line-height: 1.75rem"
                        ></i>
                        <span>No tasks in this lane.</span>
                      </div>
                    </div>
                  </ng-template>
                </p-panel>
              </div>
            </div>
          </div>
        </p-tabpanel>
        <p-tabpanel value="audit">
          <div style="display: flex; flex-direction: column; gap: 1rem">
            <p-message
              *ngIf="auditLoading()"
              severity="info"
              text="Loading recent activity…"
            ></p-message>
            <p-message
              *ngIf="auditError()"
              severity="error"
              [text]="auditError()!"
            ></p-message>
            <div
              *ngIf="!auditLoading()"
              style="display: flex; flex-direction: column; gap: 0.75rem"
            >
              <p-card
                *ngFor="let entry of auditEntries()"
                [style]="{
                  'border-radius': '1rem',
                  'box-shadow':
                    '0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px -1px rgba(0,0,0,.1)'
                }"
              >
                <div
                  [style]="{
                    display: 'flex',
                    'flex-direction': 'column',
                    gap: '0.75rem'
                  }"
                >
                  <div style="display: flex; align-items: center; gap: 0.75rem">
                    <p-avatar
                      shape="circle"
                      [label]="actorInitials(entry)"
                      style="background-color: rgb(17, 24, 39); color: #fff"
                    ></p-avatar>
                    <div style="display: flex; flex-direction: column">
                      <span style="font-weight: 500; color: rgb(17, 24, 39)">{{
                        auditLabel(entry)
                      }}</span>
                      <small style="color: rgb(107, 114, 128)"
                        >{{ entry.resourceType }} ·
                        {{ entry.resourceId | slice : 0 : 8 }}</small
                      >
                    </div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem">
                    <p-tag
                      [value]="auditLabel(entry)"
                      [severity]="auditSeverity(entry)"
                    ></p-tag>
                    <small style="color: rgb(107, 114, 128)">{{
                      formatTimestamp(entry.createdAt)
                    }}</small>
                  </div>
                </div>
                <p
                  *ngIf="auditMetadata(entry) as metaText"
                  style="
                    margin: 0;
                    font-size: 0.875rem;
                    line-height: 1.25rem;
                    color: rgb(75, 85, 99);
                  "
                >
                  {{ metaText }}
                </p>
              </p-card>
              <div
                *ngIf="!auditEntries().length && !auditError()"
                style="
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 0.5rem;
                  border: 2px dashed rgb(229, 231, 235);
                  border-radius: 1rem;
                  padding-top: 1.5rem;
                  padding-bottom: 1.5rem;
                  font-size: 0.875rem;
                  line-height: 1.25rem;
                  color: rgb(107, 114, 128);
                "
              >
                <i
                  class="pi pi-ellipsis-h"
                  style="font-size: 1.125rem; line-height: 1.75rem"
                ></i>
                <span>No audit activity recorded yet.</span>
              </div>
            </div>
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </main>

  <p-dialog
    header="Create new task"
    [visible]="isCreateDialogOpen()"
    (onHide)="closeCreateDialog()"
    [modal]="true"
    style="width: 100%; max-width: 42rem"
  >
    <form
      [formGroup]="createForm"
      (ngSubmit)="createTask()"
      style="display: grid; gap: 1rem"
    >
      <div>
        <span class="p-float-label">
          <input
            pInputText
            id="task-title"
            formControlName="title"
            style="width: 100%"
          />
          <label for="task-title">Title</label>
        </span>
      </div>
      <div>
        <span class="p-float-label">
          <textarea
            pTextarea
            autoResize
            rows="3"
            id="task-description"
            formControlName="description"
            style="width: 100%"
          ></textarea>
          <label for="task-description">Description</label>
        </span>
      </div>
      <div>
        <span class="p-float-label">
          <input
            pInputText
            id="task-category"
            formControlName="category"
            style="width: 100%"
          />
          <label for="task-category">Category</label>
        </span>
      </div>
      <div>
        <p-select
          formControlName="organizationId"
          [options]="organizations()"
          optionLabel="name"
          optionValue="id"
          placeholder="Select organization"
          style="width: 100%"
        ></p-select>
      </div>
      <div>
        <p-select
          formControlName="status"
          [options]="statusColumns"
          optionLabel="title"
          optionValue="status"
          placeholder="Select status"
          style="width: 100%"
        ></p-select>
      </div>
      <div>
        <p-select
          formControlName="priority"
          [options]="prioritySelectOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select priority"
          style="width: 100%"
        ></p-select>
      </div>
      <div>
        <p-datepicker
          formControlName="dueDate"
          inputId="task-due-date"
          dateFormat="yy-mm-dd"
          showIcon
          style="width: 100%"
        ></p-datepicker>
      </div>
      <div>
        <span class="p-float-label">
          <input
            pInputText
            id="task-assignee"
            formControlName="assigneeId"
            style="width: 100%"
          />
          <label for="task-assignee">Assign to (optional)</label>
        </span>
      </div>
      <div
        style="
          display: flex;
          justify-content: flex-end;
          gap: 0.5rem;
          padding-top: 0.5rem;
        "
      >
        <button
          pButton
          type="button"
          severity="secondary"
          (click)="closeCreateDialog()"
        >
          Cancel
        </button>
        <button
          pButton
          type="submit"
          icon="pi pi-save"
          [disabled]="createForm.invalid"
        >
          Create task
        </button>
      </div>
    </form>
  </p-dialog>
</div>
